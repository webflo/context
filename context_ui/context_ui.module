<?php
// $Id$

/**
 * Implementation of hook_block()
 */
function context_ui_block($op = 'list', $delta = 0) {
  $block = array();
  if ($op == 'list') {
    $block['devel']['info'] = t('Context Devel');
    return $block;
  }
  else if ($op == 'view') {
    switch ($delta) {
      case 'devel':
        $block['subject'] = t('Context Devel');
        if ($context = context_get()) {
          $output = theme('context_devel', $context);
          $block['content'] = $output;
        }
        else {
          $block['content'] = "<p>". t('No context information is set.') ."</p>";
        }
        break;
    }
    return $block;
  }
}

/**
 * hook_context_items()
 */
function context_ui_context_items() {
  $items = array();

  // Content Types
  $nodetypes = array();
  foreach (node_get_types() as $type) {
    $nodetypes[$type->type] = t($type->name);
  }  
  $items['node'] = array(
    'title' => t('Content Types'),
    'description' => t('Set this context when viewing a node page or using the add/edit form of one of these content types.'),
    'options' => $nodetypes,
  );
  
  // Views
  if (module_exists('views')) {
    $items['views'] = array(
      'title' => t('Views'),
      'description' => t('Set this context when displaying the page of one of these views.'),
      'options' => _context_ui_get_views(),
    );
  }
  
  // Menu
  if (module_exists('menu')) {
    // grab menu cache
    global $_menu;
    $menus = array();
    // build options using root menus
    foreach (array_reverse(menu_get_root_menus(), true) as $root_mid => $root_menu) {
      // build menu options from children of each root menu
      $menu = array();
      $options = menu_parent_options(0, $root_mid, 0);
      unset($options[key($options)]);
      foreach ($options as $mid => $title) {
        $path = $_menu['items'][$mid]['path'];
        $menu[$path] = $title;
      }
      $path = $_menu['items'][$root_mid]['path'];
      $menus[$root_mid] = "<strong>". $root_menu ."</strong>";
      $menus = $menus + $menu;
    }
    $items['menu'] = array(
      'title' => t('Menus'),
      'description' => t('Display the selected menu items as active when this context is set.'),
      'options' => $menus,
      'widget' => 'select',
    );
  }
  
  $items['user'] = array(
    'title' => t('User Pages'),
    'description' => t('Set this context when a user with selected role(s) is viewed'),
    'options' => user_roles(true),
    'widget' => 'select',
  );
  
  if (module_exists('nodequeue')) {
    $result = db_query("SELECT qid, title FROM {nodequeue_queue}");
    $options = array();
    while ($nq = db_fetch_object($result)) {
      $options[$nq->qid] = $nq->title;
    }
    $items['nodequeue'] = array(
      'title' => t('Nodequeue'),
      'description' => t('Set this context when a node in the selected nodequeue(s) is viewed.'),
      'options' => $options,
      'widget' => 'select',      
    );
  }

  // Outline
  if (module_exists('outline')) {
    $result = db_query("SELECT volume_id, title FROM {outline_volume}");
    $options = array();
    while ($vol = db_fetch_object($result)) {
      $options[$vol->volume_id] = $vol->title;
    }
    $items['outline'] = array(
      'title' => t('Outline'),
      'description' => t('Set this context when a node in the selected volumes(s) is viewed.'),
      'options' => $options,
      'widget' => 'select',      
    );
  }
  
  return $items;
}

/*
 * Implementation of hook_menu()
 */
function context_ui_menu($may_cache) {
  $items = array();
  if ($may_cache) {
    $items[] = array(
      'path' => 'admin/build/context',
      'callback' => 'context_ui_admin',
      'access' => user_access('administer site configuration'),
      'type' => MENU_NORMAL_ITEM,
      'title' => t('Context'),
      'description' => t('Associate menus, views, blocks, etc. with different contexts to structure your site.')
    );
    $items[] = array(
      'path' => 'admin/build/context/list',
      'title' => t('List'),
      'callback' => 'context_ui_admin',
      'type' => MENU_DEFAULT_LOCAL_TASK,
      'weight' => 0,
    );
    $items[] = array(
      'path' => 'admin/build/context/add',
      'callback' => 'drupal_get_form',
      'callback arguments' => array('context_ui_form', 'add'),
      'access' => user_access('administer site configuration'),
      'type' => MENU_LOCAL_TASK,
      'title' => t('Add Context'),
      'description' => t('Add a context to your site.'),
      'weight' => 1,
    );
    $items[] = array(
      'title' => t('Import'),
      'path' => 'admin/build/context/import',
      'callback' => 'context_ui_import_page',
      'access' => user_access('administer site configuration'),
      'type' => MENU_LOCAL_TASK,
      'description' => t('Import a context definition into your site.'),
      'weight' => 2,
    );
    $items[] = array(
      'path' => 'admin/build/context/edit',
      'callback' => 'drupal_get_form',
      'callback arguments' => array('context_ui_form', 'edit'),
      'access' => user_access('administer site configuration'),
      'type' => MENU_CALLBACK,
    );
    $items[] = array(
      'path' => 'admin/build/context/view',
      'callback' => 'drupal_get_form',
      'callback arguments' => array('context_ui_form', 'view'),
      'access' => user_access('administer site configuration'),
      'type' => MENU_CALLBACK,
    );
    $items[] = array(
      'path' => 'admin/build/context/export',
      'callback' => 'drupal_get_form',
      'callback arguments' => array('context_ui_export'),
      'access' => user_access('administer site configuration'),
      'type' => MENU_CALLBACK,
    );
    $items[] = array(
      'path' => 'admin/build/context/delete',
      'callback' => 'drupal_get_form',
      'callback arguments' => array('context_ui_delete_confirm'),
      'access' => user_access('administer site configuration'),
      'type' => MENU_CALLBACK,
    );
    return $items;
  }
  else {
    // Rebuild context_ui "cache".
    if ($_GET['q'] == 'admin/build/modules') {
      include_once(drupal_get_path("module", "context_ui") ."/context_ui_admin.inc");
      context_ui_rebuild();
    }

    // Attempt to override the theme_blocks.
    context_ui_block_hack();

    // Include context ui css.
    drupal_add_css(drupal_get_path("module", "context_ui") ."/context_ui.css");
  }
}

/**
 * Implementation of hook_help()
 */
function context_ui_help($section) {
  switch ($section) {
    case 'admin/build/context':
      return "<p>".
        t('Contexts provide you with a way to organize your site using terms familiar to real human beings. You can create a set of sections like <b>"News"</b>, <b>"Projects"</b>, <b>"Staff"</b>, and associate different technical aspects of Drupal to each section. For example, the <b>"News"</b> section may be a collection of <b>Nodes</b>, <b>Views</b>, <b>Menus</b> and <b>Blocks</b>.')
        ."</p>";
      break;
  }
}

/**
 * Implementation of hook_nodeapi()
 */
function context_ui_nodeapi(&$node, $op, $teaser, $page) {
  if ($op == 'view' && $page && arg(0) == 'node') {
    // Implementation of context_ui_set for node.
    context_ui_set('node', $node->type);

    // Implementation of context_ui_set for nodequeue.
    if (module_exists('nodequeue')) {
      $result = db_query("SELECT qid FROM {nodequeue_nodes} WHERE nid = %d", $node->nid);
      while($qid = db_fetch_object($result)) {
        context_ui_set('nodequeue', $qid->qid);
      }
    }

    // implementation of context_ui_set for outline
    if (module_exists('outline') && $vol = $node->volume_id) {
      context_ui_set('outline', $vol);
    }
  }
}

/**
 * Implementation of hook_form_alter()
 */
function context_ui_form_alter($form_id, &$form) {
  if ($form['#node'] && arg(0) != 'admin') { // Prevent this from firing on admin pages... damn form driven apis...
    context_ui_set('node', $form['#node']->type);
  }
  else if ($form_id == 'comment_form' && $nid = $form['nid']['#value']) {
    $node = node_load($nid);
    context_ui_set('node', $node->type);
  }
}

/**
 * Implementation of hook_views_pre_query()
 */
function context_ui_views_pre_query($view) {
  if ($view->build_type == 'page') {
    context_ui_set('views', $view->name);
  }
}

/**
 * Implementation of hook_user()
 */
function context_ui_user($op, &$edit, &$account, $category = NULL) {
  if ($op == 'view') {
    context_ui_set('user', array_keys($account->roles));
  }
}

/*
 * Invokes hook_context_define() to collect all contexts provided in code by modules.
 *
 * @param $space
 *   An optional string namespace identifier. If provided, only context definitions with the
 *   specified namespace will be returned.
 *
 * @return
 *   An array of context objects.
 */
function context_ui_defaults($space = null) {
  static $contexts, $spaces;
  if (!$contexts) {
    $contexts = array();
    foreach (module_implements('context_define') as $module) {
      $function = $module .'_context_define';
      $contexts = array_merge($contexts, $function());      
    }
    foreach ($contexts as &$context) {
      $context = (object) $context;
      $spaces[$context->space][] = $context;
    }
  }
  if ($space) {
    if (isset($spaces[$space])) {
      return $spaces[$space];
    }
    else {
      return array();
    }
  }
  return $contexts;
}

/*
 * Invokes hook_context_items() to provides an array of item types that a context may be associated with.
 */
function context_ui_types($op = 'list') {
  static $types;
  if (!$types) {
    $types = array();
    foreach (module_implements('context_items') as $module) {
      $function = $module .'_context_items';
      $types = array_merge($types, $function());
    }
  }
  switch ($op) {
    case 'list':
      return array_keys($types);
      break;
    case 'full':
      return $types;
      break;
  }
}

/*
 * Page callback for context_ui admin landing page.
 */
function context_ui_admin() {
  include_once(drupal_get_path("module", "context_ui") ."/context_ui_admin.inc");
  
  // rebuild blocks
  _block_rehash();

  // rebuild default contexts
  context_ui_rebuild();

  // User defined contexts
  $output = "<h3>". t('User context definitions') ."</h3>";
  $contexts = context_ui_tree('ui');
  if ($contexts) {
    $output .= theme('context_ui_admin', $contexts);
  }
  else {
    $output .= "<p>". t('Please !add_context to get started.', array('!add_context' => l(t('add a context'), 'admin/build/context/add'))) ."</p>";
  }

  // Module defined contexts
  $output .= "<h3>". t('Module context definitions') ."</h3>";  
  $contexts = context_ui_tree('system');
  if ($contexts) {
    $output .= theme('context_ui_admin', $contexts);
  }
  else {
    $output .= "<p>". t('There are currently no module defined contexts.') ."</p>";
  }
    
  return $output;
}

/*
 * Generates the omnibus context definition editing form.
 * Note: submission and validation handlers are in context_ui_admin.inc
 *
 * @param $op
 *   The type of form to build. Either "add", "view" or "edit"
 * @param $cid
 *   The db context identifier - required when $op == "edit"
 *
 * @return
 *   A Drupal form array.
 */
function context_ui_form($op, $cid = NULL, $context = NULL) {
  include_once(drupal_get_path("module", "context_ui") ."/context_ui_admin.inc");
  
  drupal_add_css(drupal_get_path("module", "context_ui") ."/context_ui.css");
  drupal_add_js(drupal_get_path("module", "context_ui") ."/context_ui.js");

  switch ($op) {
    case 'add':
      if (is_object($context)) {
        $context->system = true;
        if ($exists = context_ui_context('load', $context)) {
          drupal_set_message(t('A module is already providing a context with this space/key/value identifier. Your context definition will override its settings.'));
        }
        $context->system = false;
      }
      break;
    case 'view':
      if (is_numeric($cid) && $context = context_ui_context('load', $cid)) {
        drupal_set_title(t('View %title', array('%title' => $context->value)));
      }
      else {
        drupal_goto('admin/build/context'); return;
      }
      break;
    case 'edit':
      if (is_numeric($cid) && $context = context_ui_context('load', $cid)) {
        if (!$context->system) {
          drupal_set_title(t('Edit context: %title', array('%title' => $context->value)));
        }
        else {
          drupal_goto('admin/build/context'); return;
        }
      }
      break;
  }
  
  // Core context definition
  $form = array(
    '#base' => 'context_ui_form',
  );
  $form['value'] = array(
    '#type' => 'textfield',
    '#title' => t('Value'),
    '#required' => true,
    '#maxlength' => 64,
    '#size' => 20,
    '#description' => t('A system name for this context. May only contain lowercase letters, underscores, and numbers. Example: <b>science_blog</b>'),
  );
  $form['key'] = array(
    '#type' => 'textfield',
    '#title' => t('Key'),
    '#default_value' => 'section',
    '#required' => true,
    '#maxlength' => 64,
    '#size' => 20,
    '#description' => t('The type of context information provided in this namespace. Example: <b>section</b>'),
  );
  $form['space'] = array(
    '#type' => 'textfield',
    '#title' => t('Namespace'),
    '#default_value' => 'context_ui',
    '#required' => true,
    '#maxlength' => 64,
    '#size' => 20,
    '#description' => t('The namespace for this context definition. Example: <b>context_ui</b>'),
  );

  $form['items'] = array(
    '#tree' => true,
  );

  // Generate settings for context item associations
  foreach (context_ui_types('full') as $type => $item) { 
    $form['items'][$type] = array(
      '#title' => $item['title'],
      '#description' => $item['description'],
      '#type' => 'checkboxes',
      '#size' => 8,
      '#multiple' => true,
      '#options' => $item['options'],
    );
  }

  // Control block visibility
  init_theme(); // we need to initialize theme in order to deal with blocks
  global $theme_key;
  $block_options =
  $block_defaults = array();
  $blocks = _context_ui_get_blocks();
  $regions = system_region_list($theme_key);
  // $blocks in [0] have not been assigned a region
  foreach ($blocks[0] as $block) {
    if (!isset($context->block[$block->bid])) {
      $block_options[$block->module][$block->bid] = $block->label . " ($block->bid)";
    }
  }
  ksort($block_options);

  $form['block'] = array(
    '#tree' => true,
  );

  $form['block']['selector'] = array(
    '#description' => t('Control block visibility using context. Selected blocks will be shown when this context is set provided that custom block visibility settings and/or throttling do not hide them. Grayed out blocks are those provided by Drupal\'s standard block settings. These settings apply to the current theme and any enabled themes with regions in common.'),
    '#type' => 'item',
    '#tree' => true,
    '#prefix' => '<div class="context-ui-block-selector">',
    '#suffix' => '</div>',
    'blocks' => array(
      '#type' => 'select',
      '#multiple' => true,
      '#size' => 15,
      '#title' => t('Blocks'),
      '#options' => $block_options,
    ),
    'regions' => array(
      '#type' => 'select',
      '#title' => t('Regions'),
      '#options' => $regions,
    ),
    'add' => array(
      '#type' => 'markup',
      '#value' => "<input id='edit-block-selector-add' class='form-submit' type='button' value='+ ". t('Add') ."'/>",
    ),
  );
  $form['block']['regions'] = array(
    '#type' => 'item',
    '#tree' => true,
    '#prefix' => '<div class="context-ui-block-regions">',
    '#suffix' => '</div>',
    '#value' => theme('context_ui_block_ui', $regions, $context),
  );
  foreach (array_keys($regions) as $region) {
    $defaults = array();
    $midpoint = false;
    foreach (_context_ui_get_blocks($region, $context) as $block) {
      if ($block->type == 'context_ui') {
        $defaults[] = $block->bid;
      }
      else if (!$midpoint) {
        $midpoint = true;
        $defaults[] = 'system';
      }
    }
    if (!$defaults) {
      $defaults = array('system');
    }
    $defaults = implode(',', $defaults);
    $form['block']['regions'][$region] = array(
      '#type' => 'hidden',
      '#default_value' => $defaults,
    );
  }

  if ($op == 'view') {
    $form[] = array(
      '#type' => 'item',
      '#value' => l(t('Back'), 'admin/build/context'),
    );
  }
  
  if ($op != 'view') {
    $form[] = array(
      '#type' => 'submit',
      '#value' => t('Save'),    
    );
  }
  
  if ($op == 'edit') {
    $form[] = array(
      '#type' => 'submit',
      '#value' => t('Delete'),
    );  
  }

  if ($op == 'view' || $op == 'edit' || ($op == 'add' && $context)) {
    if ($context) {
      $form['value']['#default_value'] = $context->value;
      $form['key']['#default_value'] = $context->key;
      $form['space']['#default_value'] = $context->space;
      $form['cid'] = array(
        '#type' => 'value',
        '#value' => $cid,
      );
      $form['system'] = array(
        '#type' => 'value',
        '#value' => $context->system,
      );
      if ($op == 'view' || $context->system) {        
        $form['value']['#disabled'] = 
        $form['key']['#disabled'] = 
        $form['space']['#disabled'] = 
        $form['block']['selector']['blocks']['#disabled'] = 
        $form['block']['selector']['regions']['#disabled'] = true;
      }
      // Set default values for each item type (except blocks)
      foreach (context_ui_types() as $type) {
        if (is_array($context->{$type})) {
          $defaults = array();
          foreach ($context->{$type} as $id) {
            $defaults[$id] = $id;
          }
          $form['items'][$type]['#default_value'] = $defaults;
        }
        $form['items'][$type]['#disabled'] = $op == 'view' ? true : false;
      }
      // Blocks must be selected by region
      if (is_array($context->block)) {
        foreach ($regions as $region => $label) {
          if (is_array($form['block'][$region])) {
            $defaults = array();
            foreach ($form['block'][$region]['#options'] as $block => $label) {
              if (array_search($block, $context->block) !== false) {
                $defaults[$block] = $block;
              }
            }
            $form['block'][$region]['#default_value'] = $defaults;
          }
          $form['block'][$region]['#disabled'] = $op == 'view' ? true : false;
        }
      }
    }
    else {
      return drupal_goto('admin/build/context');
    }
  }

  return $form;
}

/*
 * Theme function for context_ui_form()
 */
function theme_context_ui_form($form) {
  $output = '';

  // Render space / key / value trio in a 3-column table
  $header = array(t('Namespace'), t('Key'), t('Value'));
  unset($form['space']['#title']);
  unset($form['key']['#title']);
  unset($form['value']['#title']);
  $rows = array(
    array(
      drupal_render($form['space']),
      drupal_render($form['key']),
      drupal_render($form['value']),
    ),
  );
  $output .= theme('table', $header, $rows, array('class' => 'context-ui-3col'));

  // Render setters / getters as a two column split
  $header = array(t('Set context'), t('Respond to context'));
  $getters = drupal_render($form['items']['menu']);
  $setters = drupal_render($form['items']);
  $rows = array(
    array(
      array('data' => $setters, 'class' => 'setters left'),
      array('data' => $getters, 'class' => 'getters right'),
    ),
  );
  $output .= theme('table', $header, $rows, array('class' => 'context-ui-2col'));

  // Block visibility
  $header = array(t('Blocks'), t('Regions'));
  $rows = array(
    array(
      array('data' => drupal_render($form['block']['selector']), 'class' => 'left'),
      array('data' => drupal_render($form['block']['regions']), 'class' => 'right'),
    ),
  );
  $output .= theme('table', $header, $rows, array('class' => 'context-ui-2col'));
  
  $output .= drupal_render($form);
  return $output;
}

/*
 * Provide a form to confirm deletion of a context definition.
 */
function context_ui_delete_confirm($cid) {
  include_once(drupal_get_path("module", "context_ui") ."/context_ui_admin.inc");
  
  $context = context_ui_context('load', $cid);
  if (!$context) {
    return drupal_goto('admin/build/context');
  }
  $form['cid'] = array('#type' => 'value', '#value' => $cid);
  $form = confirm_form($form,
    t('Are you sure you want to delete %title?', array('%title' => $context->value)),
    'admin/build/context',
    t('This action cannot be undone.'),
    t('Delete'), t('Cancel')
  );
  return $form;
}

/*
 * hook_submit()
 */
function context_ui_delete_confirm_submit($form_id, $form) {
  context_ui_context('delete', $form['cid']);
  context_ui_rebuild();
  return 'admin/build/context';
}

/*
 * Page callback for import form. Switches form output to context form
 * if import submission has occurred.
 */
function context_ui_import_page() {
  if ($_POST['form_id'] == 'context_ui_form') {
    return drupal_get_form('context_ui_form', 'add');
  }
  return drupal_get_form('context_ui_import');
}

/*
 * Import form. Provides simple helptext instructions and textarea for
 * pasting a context definition.
 */
function context_ui_import() {
  drupal_set_title(t('Import context'));
  $help = t('You can import a context definition by pasting the exported context object code into the field below.');
  $form = array();
  $form['help'] = array(
    '#type' => 'item',
    '#value' => $help,
  );
  $form['import'] = array(
    '#title' => t('Context Object'),
    '#type' => 'textarea',
    '#rows' => 10,
    '#required' => true,
  );
  $form['submit'] = array(
    '#type' => 'submit',
    '#value' => t('Import'),
  );
  
  return $form;
}

/*
 * Import form submit handler. Evaluates import code and transfers to
 * context definition form.
 */
function context_ui_import_submit($form_id, $form_values) {
  include_once(drupal_get_path("module", "context_ui") ."/context_ui_admin.inc");
  $items = array();
  if ($import = $form_values['import']) {
    ob_start();
    eval($import);
    ob_end_clean();
  }
  if (is_array($items) && count($items)) {
    $context = current($items);
  }
  if (is_array($context)) {
    $context = (object) $context;
    $context->system = FALSE;
    if ($exists = context_ui_context('load', $context)) {
      drupal_set_message(t('A user-defined context definition with this space/key/value identifier already exists. Please remove the existing context before importing this definition.'), 'error');
      return 'admin/build/context';
    }
    else {
      drupal_set_title(t('Add context'));
      $output = drupal_get_form('context_ui_form', 'add', null, (object) $context);
      print theme('page', $output);
      exit;
    }
  }
  else {
    drupal_set_message(t('An error occurred while importing. Please check your context definition.', 'error'));
    return 'admin/build/context';
  }
}

/*
 * Provides a form with an exported context definition for use in modules.
 *
 * @param $cid
 *   A context id.
 *
 * @return
 *   A FormAPI array.
 */
function context_ui_export($cid = NULL) {
  include_once(drupal_get_path("module", "context_ui") ."/context_ui_admin.inc");
  
  if (is_numeric($cid) && $context = context_ui_context('load', $cid)) {
    drupal_set_title(t('Export %title', array('%title' => $context->value)));

    // help text -- too bad the help module in 5 doesn't take wildcards
    $help = t('You can use exported contexts in your modules by returning an array of defined contexts in <code>hook_context_define()</code>.');

    // prune system specific information and cast for Drupal's AOP (array oriented programming)
    unset($context->cid);
    unset($context->status);
    unset($context->system);
    $context = (array) $context;

    // clean up blocks
    foreach ($context['block'] as $bid => $block) {
      unset($block->bid);
      $context['block'][$bid] = (array) $block;
    }

    // export
    $export = '$items[] = '. var_export($context, true) .';';
    
    // build the form
    $form = array();
    $form['help'] = array(
      '#type' => 'item',
      '#value' => $help,
    );
    $form['export'] = array(
      '#type' => 'textarea',
      '#rows' => 24,
      '#default_value' => $export,
    );
    return $form;
  }
  else {
    drupal_goto('admin/build/context'); return;
  }
}

/**
 * Sets a space-key-value context that has been associated with the provided item.
 *
 * @param $type
 *   The item type to be matched. Any of the currently supported context items types ("view",
 *   "node", etc.) can be specified.
 * @param $id
 *   An array of string or integer ids of the context item to match. Individual ids are also accepted.
 *
 * @return
 *   True if one or more contexts were set. False if no items/contexts matched.
 */
 function context_ui_set($type, $id) {
  if (!is_array($id)) {
    $id = array($id);
  }
  $set = false;
  $result = db_query("
    SELECT c.space, c.key, c.value, c.cid FROM {context_ui_item} ci
    JOIN {context_ui} c ON ci.cid = c.cid
    WHERE ci.type = '%s' AND ci.id IN (". substr(str_repeat("'%s',", count($id)), 0, -1) .") AND c.status = 1",
    array_merge(array($type), $id));
  if (db_num_rows($result) > 0) {
    while ($context = db_fetch_object($result)) {
      // If this context already has a value, don't alter it.
      if (!context_exists($context->space, $context->key)) {
        context_set($context->space, $context->key, $context->value);
        context_ui_menu_set_location($context);

        // Store the cid of set contexts. Other parts of the stack may be interested.
        $cid = context_get('context_ui', 'cid');
        $cid = $cid ? $cid : array();
        $cid[] = $context->cid;
        context_set('context_ui', 'cid', $cid);
      }
    }
    $set = true;
  }
  return $set;
}

/**
 * Takes a retrieved context array and returns a themed out tree representation of that context.
 */
function theme_context_devel($context) {
  $output = '';
  foreach ($context as $space => $a) {
    $output .= "<div class='context-devel-space'>$space</div>";
    $output .= "<div class='context-devel-tree'>". theme_context_devel_recurse($a) ."</div>";
  }
  return $output;
}

/**
 * Helper function to theme_context_devel that recurses down context arrays and themes accordingly.
 */
function theme_context_devel_recurse($value) {
  if (is_array($value) || is_object($value)) {
    if (is_array($value)) {
      $type = 'array';
    }
    else if (is_object($value)) {
      $type = 'object';
    }
    foreach ((array)$value as $key => $a) {
      $output .= "<div class='context-devel-wrapper'><label><small>$type</small>$key</label>". theme('context_devel_recurse', $a) ."</div>";
    }
  }
  else {
    if (is_string($value)) {
      $type = 'string';
    }
    else if (is_int($value)) {
      $type = 'int';
    }
    else if (is_bool($value)) {
      $type = 'bool';
    }
    $output .= "<div class='context-devel-wrapper'><label><small>$type</small>$value</label></div>";
  }
  return $output;
}

/**
 * Alters the menu to reflect any active contexts. Called from context_ui_set().
 */
function context_ui_menu_set_location($context) {
  if ($context->cid) {
    $result = db_query("
      SELECT ci.id
      FROM {context_ui_item} ci
      WHERE ci.type = '%s' AND ci.cid = %d",
      'menu', $context->cid);
    if ($path = db_result($result)) {
      // Load global menu -- unfortunately we may have to modify it manually
      global $_menu;

      // Get menu item for active context
      $context_menu = menu_get_item(null, $path);
      $items[] = $context_menu;      

      // Grab the menu tree from active context item to the root
      $mid = $context_menu['pid'];
      while ($mid && ($item = menu_get_item($mid))) {
        $items[] = $item;
        $mid = $item['pid'];
      }
      $items = array_reverse($items);

      // Graft the current active page on if it is different
      $active_mid = menu_get_active_item();
      if ($active_mid != $_menu['path index'][$path] && !$items[$active_mid]) {
        $active_menu = menu_get_item($active_mid);        
        // Due to a bug/feature? of menu_set_location() menu leaves that
        // are part of the 'visible' portion of the menu tree short-circuit
        // any further menu grafting. We check here, and make sure the leaf
        // item is not a visible one.        
        if (isset($_menu['visible'][$active_mid])) {      
          unset($_menu['visible'][$active_mid]);
        }

        // If the active menu item is a local task we need to make sure
        // to include it's parent.
        if ($active_menu['type'] & MENU_IS_LOCAL_TASK) {
          if ($active_menu['type'] & MENU_DEFAULT_LOCAL_TASK) {
            $real_q = end($items);
            $real_q = $real_q['path'];
          }
          $parent_menu = menu_get_item($active_menu['pid']);
          $items[] = $parent_menu;

          // Allow for two levels of local tasks.
          if ($parent_menu['type'] & MENU_IS_LOCAL_TASK) {
            $items[] = menu_get_item($parent_menu['pid']);
          }
        }
        $items[] = $active_menu;
      }

      // Push the new location path through
      menu_set_location($items);

      // Repair query string
      if ($real_q) {
        $_GET['q'] = $real_q;
      }
    }
  }
}

/**
 * TODO - Rework this, we're may just to require phptemplate and not allow for the theme to implement a 
 *        phptemplate_blocks function. Otherwise we may check for that namespace and use a backup otherwise.
 *
 * An egregious hack. Checks the function namespace for a theme and theme engine override of theme_blocks
 * and attempts to take the first available override. If all else fails, falls back to a custom
 * context_ui theme function namespace that requires custom implementation by the themer.
 */
function context_ui_block_hack() {
  /*
  global $theme, $theme_engine;
  if (!function_exists($theme .'_blocks')) {
    $f_name = $theme .'_blocks';
  }
  else if (!function_exists($theme_engine .'_blocks')) {
    $f_name = $theme_engine .'_blocks';
  }
  else {
    $f_name = 'theme_context_ui_blocks';
  }
  $f_name = str_replace('-', '_', $f_name);
  */
  $f_name = 'phptemplate_blocks';
  $eval = '
  function '. $f_name .'($region) {
    $output = "";
    if ($list = context_ui_block_list($region)) {
      foreach ($list as $key => $block) {
        $output .= theme("block", $block);
      }
    }
    // Add any content assigned to this region through drupal_set_content() calls.
    $output .= drupal_get_content($region);
    return $output;
  }';
  eval($eval);
}

/**
 * An alternative version of block_list() that provides any context_ui enabled blocks.
 */
function context_ui_block_list($region) {
  global $user, $theme_key;

  static $blocks, $cids;

  $defaults = array();

  if (!count($blocks)) {
    $blocks = array();
    $cids = array();

    // generate list of active DB contexts
    // formerly an API function -- TODO: evaluate whether this may be useful otherwise
    $result = db_query("SELECT * FROM {context_ui} WHERE status = 1", 'context_ui');
    while ($context = db_fetch_object($result)) {
      if (context_get($context->space, $context->key) == $context->value) {
        $cids[$context->cid] = $context->cid;
      }
    }

    $rids = array_keys($user->roles);
    $placeholders = implode(',', array_fill(0, count($rids), '%d'));
    $result = db_query("
      SELECT DISTINCT b.*, c.weight AS context_weight, c.region AS context_region, c.cid
      FROM {blocks} b
      LEFT JOIN {blocks_roles} r ON b.module = r.module AND b.delta = r.delta
      LEFT JOIN {context_ui_block} c ON b.module = c.module AND b.delta = c.delta
      WHERE b.theme = '%s' AND (r.rid IN ($placeholders) OR r.rid IS NULL)
      ORDER BY b.region, b.weight, b.module",
      array_merge(array($theme_key), $rids)
    );
    while ($block = db_fetch_object($result)) {
      // we determine status as a combination of DB setting + context definition
      $status = FALSE;
      // prepare context blocks
      // if cid is in active contexts, use context weight + region
      if (isset($block->cid) && in_array($block->cid, $cids)) {
        $block->context_ui = TRUE;
        $block->region = $block->context_region ? $block->context_region : $block->region;
        $block->weight = $block->context_weight ? $block->context_weight : $block->weight;
        $status = TRUE;
      }
      // use db setting
      else {
        $status = $block->status;
      }

      if ($status) {
        if (!isset($blocks[$block->region])) {
          $blocks[$block->region] = array();
        }
        $enabled = _context_ui_block_visibility('user', $block);
        $page_match = _context_ui_block_visibility('page', $block);
        $throttle = _context_ui_block_visibility('throttle', $block);  
        if ($enabled && $page_match && $throttle) {
          // Invoke hook_block('view');
          $array = module_invoke($block->module, 'block', 'view', $block->delta);
          if (isset($array) && is_array($array) && $array['content']) {
            foreach ($array as $k => $v) {
              $block->$k = $v;
            }
            // Override default block title if a custom display title is present.
            if ($block->title) {
              // Check plain here to allow module generated titles to keep any markup.
              $block->subject = $block->title == '<none>' ? '' : check_plain($block->title);
            }
            $blocks[$block->region]["{$block->module}_{$block->delta}"] = $block;
          }
        }
      }
    }
    // Custom sort since SQL order by won't give it to us for free
    foreach ($blocks as &$region_blocks) {
      uasort($region_blocks, '_context_ui_block_compare');
    }
  }
  // Create an empty array if there were no entries
  if (!isset($blocks[$region])) {
    $blocks[$region] = array();
  }
  return $blocks[$region];
}

function _context_ui_block_visibility($op, $block) {
  switch ($op) {
    case 'user':
      global $user;
      // Use the user's block visibility setting, if necessary
      if ($block->custom != 0) {
        if ($user->uid && isset($user->block[$block->module][$block->delta])) {
          return $user->block[$block->module][$block->delta];
        }
        else {
          return ($block->custom == 1);
        }
      }
      return true;
    case 'page':
      // Match path if necessary
      if ($block->pages) {
        if ($block->visibility < 2) {
          $path = drupal_get_path_alias($_GET['q']);
          $regexp = '/^('. preg_replace(array('/(\r\n?|\n)/', '/\\\\\*/', '/(^|\|)\\\\<front\\\\>($|\|)/'), array('|', '.*', '\1'. preg_quote(variable_get('site_frontpage', 'node'), '/') .'\2'), preg_quote($block->pages, '/')) .')$/';
          // Compare with the internal and path alias (if any).
          $page_match = preg_match($regexp, $path);
          if ($path != $_GET['q']) {
            $page_match = $page_match || preg_match($regexp, $_GET['q']);
          }
          // When $block->visibility has a value of 0, the block is displayed on
          // all pages except those listed in $block->pages. When set to 1, it
          // is displayed only on those pages listed in $block->pages.
          return !($block->visibility xor $page_match);
        }
        else {
          return drupal_eval($block->pages);
        }
      }
      return true;
    case 'throttle':
      if (!($block->throttle && (module_invoke('throttle', 'status') > 0))) {
        return true;
      }
      return false;
  }
}

/*
 * Helper function to sort block objects by weight
 */
function _context_ui_block_compare($a, $b) {
  // Enabled blocks
  return ($a->weight - $b->weight);
}

/*
 * Provides simple operations (load/insert/update/etc.) on a core context space/key/value definition.
 *
 * @param $op
 *   Operation to perform on a context. May be one of load/insert/update/delete.
 * @param $context
 *   A context object. Optionally, can be an integer cid for the "load" operation.
 *
 * @return
 *   If loading, returns a full context item. All other operations return true on success and false on failure.
 */
function context_ui_context($op, $context) {
  switch ($op) {
    case 'load':
      static $cache;
      if (!$cache) {
        $cache = array();
      }
      // Argument is a cid
      if (is_numeric($context)) {
        if (!$cache[$context]) {
          $context = db_fetch_object(db_query("SELECT * FROM {context_ui} WHERE cid = %d", $context));
        }
        else {
          return $cache[$context];
        }
      }
      // Context object has an associated cid
      else if (is_object($context) && $context->cid) {
        if (!$cache[$context->cid]) {
          $context = db_fetch_object(db_query("SELECT * FROM {context_ui} WHERE cid = %d", $context->cid));
        }
        else {
          return $cache[$context->cid];
        }
      }
      // Context object has no cid -- we'll try to load by s/k/v
      else if (is_object($context) && $context->space && $context->key && $context->value) {
        $args = array(
          $context->space,
          $context->key,
          $context->value,
        );
        if ($context->system) {
          $args[] = $context->system;
          $system = "AND system = '%s'";
        }
        if ($context->status) {
          $args[] = $context->status;
          $status = "AND status = %d";
        }
        $context = db_fetch_object(db_query("SELECT * FROM {context_ui} WHERE space = '%s' AND `key` = '%s' AND value = '%s' $system $status", $args));
      }
      if ($context) {
        $context = context_ui_item('load', $context);
        $context = context_ui_item_block('load', $context);
        // After all that hard work, cache the context
        $cache[$context->cid] = $context;
        return $context;
      }
      return false;
    case 'insert':
      // check for type & existence of context definition
      $existing = context_ui_context('load', $context);
      if (!$existing || $existing->system != $context->system) {
        $context->cid = db_next_id('{context_ui}_cid');
        $values = array(
          'cid' => $context->cid,
          'system' => $context->system,
          'status' => $context->status,
          'space' => $context->space,
          '`key`' => $context->key,
          'value' => $context->value,
        );
        $keys = implode(', ', array_keys($values));
        $args = array_merge(array($keys), $values);
        $result = db_query("INSERT INTO {context_ui} (%s) VALUES(%d, %d, %d, '%s', '%s', '%s')", $args);
        $result = $result && context_ui_item('save', $context);
        $result = $result && context_ui_item_block('save', $context);
        return $result ? true : false;
      }
      return false;
      break;
    case 'update':
      if ($context->cid) {
        // update core context information
        $values = array(
          'system' => $context->system,
          'status' => $context->status,
          'space' => $context->space,
          '`key`' => $context->key,
          'value' => $context->value,
          'cid'   => $context->cid,
        );
        $keys = implode(', ', array_keys($values));
        $result = db_query("UPDATE {context_ui} SET system = %d, status = %d, space = '%s', `key` = '%s', value = '%s'WHERE cid = %d", $values);
        $result = $result && context_ui_item('save', $context);
        $result = $result && context_ui_item_block('save', $context);
        return $result ? true : false;
      }
      break;
    case 'delete':
      if ($context = context_ui_context('load', $context)) {
        db_query("DELETE FROM {context_ui} WHERE cid = %d", $context->cid);
        db_query("DELETE FROM {context_ui_item} WHERE cid = %d", $context->cid);
        db_query("DELETE FROM {context_ui_block} WHERE cid = %d", $context->cid);
        return true;
      }
      return false;
  }
}

/*
 * Provides simple operations (load/save) on any context-item associations. context_ui_item() will
 * automatically sync the database with the context object provided when saving. Any associations
 * that exist on the object that are absent from the database will be inserted, and any associations
 * that are missing will be removed from the database.
 *
 * @param $op
 *   Operation to perform on a context. May be either load or save.
 * @param $context
 *   A context object with item associations.
 *
 * @return
 *   Load returns a context object with item associations. Save returns true on success and false on failure.
 */
function context_ui_item($op = 'load', $context) {
  if ($context->cid) {
    switch ($op) {
      case 'load':
        $result = db_query("SELECT * FROM {context_ui_item} WHERE cid = %d", $context->cid);
        while ($page = db_fetch_object($result)) {
          $context->{$page->type}[$page->id] = $page->id;
        }
        return $context;
      case 'save':
        $current = (object) array('cid' => $context->cid);
        $current = context_ui_item('load', $current);
        foreach (context_ui_types() as $type) {
          // Delete any stale associations
          if (is_array($current->{$type})) {
            foreach ($current->{$type} as $id) {
              $delete = false;
              if (!is_array($context->{$type})) {
                $delete = true;
              }
              else if (array_search($id, $context->{$type}) === false) {
                $delete = true;
              }
              if ($delete) {
                $result = db_query("DELETE FROM {context_ui_item} WHERE cid = %d AND type = '%s' AND id = '%s'", $context->cid, $type, $id);
              }
            }
          }
          // Add/update any missing associations
          if (is_array($context->{$type})) {
            foreach ($context->{$type} as $id) {
              $update = false;
              if (!is_array($current->{$type})) {
                $update = true;
              }
              else if (array_search($id, $current->{$type}) === false) {
                $update = true;
              }
              if ($update) {
                $result = db_query("REPLACE INTO {context_ui_item} (cid, type, id) VALUES(%d, '%s', '%s')", $context->cid, $type, $id);
              }
            }
          }
        }
        return true;
        break;
    }
  }
  return false;
}

/*
 * Provides simple operations (load/save) on any context-block associations. Parallel usage as
 * context_ui_item().
 *
 * @param $op
 *   Operation to perform on a context. May be either load or save.
 * @param $context
 *   A context object with an array of blocks at $context->block.
 *
 * @return
 *   Load returns a context object with block information. Save returns true on success and false on failure.
 */
function context_ui_item_block($op = 'load', $context) {
  if ($context->cid) {
    switch ($op) {
      case 'load':
        $result = db_query("SELECT module, delta, region, weight FROM {context_ui_block} WHERE cid = %d", $context->cid);
        $context->block = array();
        while ($block = db_fetch_object($result)) {
          $bid = $block->module ."_". $block->delta;
          $block->bid = $bid;
          $context->block[$bid] = $block;
        }
        return $context;
        break;
      case 'save':
        // grab the current context-> block associations
        $current = (object) array('cid' => $context->cid);
        $current = context_ui_item_block('load', $current);
        // compare current definition with new definition. remove missing associations from the DB
        if (is_array($current->block)) {
          foreach ($current->block as $block) {
            if (!isset($context->block[$block->bid]) || $current->block[$block->bid] != $context->block[$block->bid]) {
              $result = db_query("DELETE FROM {context_ui_block WHERE cid = %d AND module = '%s' AND delta = '%s'", $context->cid, $block->module, $block->delta);
            }
          }
        }
        // compare new definition with current definition. add missing associations to the DB
        if (is_array($context->block)) {
          foreach ($context->block as $block) {
            $block = (object) $block;
            if (!isset($current->block[$block->bid]) || $current->block[$block->bid] != $context->block[$block->bid]) {
              $args = array(
                'module' => $block->module,
                'delta' => $block->delta,
                'region' => $block->region,
                'weight' => $block->weight,
                'cid' => $context->cid,
              );
              $result = db_query("REPLACE INTO {context_ui_block} (module, delta, region, weight, cid) VALUES ('%s', '%s', '%s', %d, %d)", $args);
            }
          }
        }
        return true;
        break;
    }
  }
  return false;
}

/**
 * Generates a themed set of links for node types associated with
 * the current active contexts.
 */
function theme_context_ui_node_links() {
  $output = '';
  $links = _context_ui_node_links();
  foreach ($links as $link) {
    $output .= l('+ '. t('Add !type', array('!type' => $link['title'])), $link['href'], array('class' => 'button'));
  }
  return $output;
}

/**
 * Generates an array of links (suitable for use with theme_links)
 * to the node forms of types associated with current active contexts.
 */
function _context_ui_node_links($resest = false) {
  static $links;
  if (!$links || $reset) {
    $links = array();
    if ($cids = context_get('context_ui', 'cid')) {
      // Collect types
      $types = node_get_types();
      // Iterate over active contexts
      foreach ($cids as $cid) {
        $context = context_ui_context('load', $cid);
        if (is_array($context->node)) {
          foreach ($context->node as $type) {      
            if (isset($types[$type]) && node_access('create', $type)) {
              $links[$type] = array(
                'title' => $types[$type]->name,
                'href' => 'node/add/'. $type,
              );
            }
          }
        }
      }
    }
  }
  return $links;
}
